## 개선 계획(상세)

본 문서는 사용자 제안 사항을 바탕으로 우선순위/세부 구현 계획/수용 기준(AC)/권장 설계를 정리합니다.

### 1. 우선순위 요약

**1순위 (핵심 기능 및 안정성)**
- 프록시 서버/그룹 관리: 동일 호스트 등록 방지 및 필수 입력값 검증
- 세션 브라우저: 세션 불러오기 속도 개선
- 자원사용률: 그래프 구현 및 평균값 모니터링(1차 완료: 그래프/평균·이동평균·누적평균/자동 새로고침)

**2순위 (사용성 및 편의 기능)**
- 세션 브라우저: 상세 검색 기능 및 테이블 서식 적용
- 프록시 서버/그룹 관리: 일괄 등록/수정/삭제 및 서버 검색 기능
- 자원사용률: 임계치별 색상 구현 및 헤더 고정

**3순위 (기타 개선)**
- 세션 브라우저: 세션 엑셀 저장(완료: 서버사이드 CSV 스트리밍, 전체 컬럼 지원)
- 프록시 서버/그룹 관리: 삭제 팝업 개선 및 포트 값 제거
- 자원사용률: 대상 선택 로직 개선

**4순위 (신규 기능)**
- 로그 수집: 별도 프로젝트로 계획 필요

---

### 2. 상세 항목 및 기술 설계

#### A. 세션 브라우저
1) [성능] 세션 불러오기 속도 최적화
- 현황: ThreadPoolExecutor(동시 4) + 파싱 최적화 기반 수집 구현됨.
- 개선안:
  - 동시성/타임아웃을 DB 설정에 노출(현재 일부 반영). `max_workers`, `timeout_sec` 동적 튜닝
  - 프록시 그룹/ID 기준 배치 처리, 실패 재시도(지수 백오프)
  - 최근 수집 이후 증분 수집(가능 시), 또는 마지막 N분 내 세션만 필터
  - 인덱스 최적화: `session_records(proxy_id, collected_at)` 복합 인덱스
  - 최신 배치 조회 최적화: 서브쿼리 대신 `row_number()` 활용 검토
- 수용 기준(AC): 동일 조건에서 평균 수집 시간 30% 이상 단축, 타임아웃/실패율 감소

2) [기능] 상세 검색 기능 추가
- API: `/api/session-browser`에 필터 파라미터(예: `client_ip`, `user_name`, `status`, 기간 등) 추가
- UI: 입력 필드 + 디바운스 검색, 서버 페이징/정렬 연동
- AC: 지정된 필터 조합으로 1초 내 서버 응답(상위 10만 건 데이터셋 기준 인덱스 전제)

3) [UI/UX] 테이블 값 포맷(날짜, 숫자 등)
- 날짜 컬럼 표준 포맷(로케일/타임존 옵션), 바이트 단위 가독성(예: KB/MB)
- 고정 헤더, 컬럼 폭 자동/커스텀, 상태값 컬러 배지

4) [기능] 세션 데이터 엑셀 저장
- 서버 측: 필터 결과 -> CSV/XLSX 스트리밍 응답
- UI: 현재 검색 조건 그대로 다운로드 버튼 제공
- AC: 10만 행 내 10초 이내 생성, 메모리 폭주 방지(스트리밍/청크)

5) [UI/UX] 대상 선택 로직 개선
- 그룹/프록시 다중 선택, 최근 사용 대상 캐시, 전체 선택 안전 가드(경고/분할)

#### B. 프록시 서버/그룹 관리
1) [안정성] 동일한 호스트 중복 등록 방지
- DB: `proxies(host)` 유니크 인덱스 추가(포트 제거 계획과 정합)
- API: 생성/수정 시 사전 중복 검사 및 409 반환
- AC: 중복 입력 시 서버/클라이언트 모두 차단

2) [안정성] 필수 입력값 검증 강화
- Pydantic: `host` 정규식(호스트네임/IP), `username` 빈값 금지 옵션
- UI: 실시간 검증/오류 메시지

3) [기능] 일괄 등록/수정/삭제
- API: `/api/proxies/bulk` (create/update/delete) 트랜잭션 처리
- CSV/XLSX 업로드 파이프라인, 실패 행 리포트

4) [데이터] 포트 값 제거
- DB 마이그레이션: `port` 컬럼 제거 전환 계획
  - 1단계: 더미/기본값 고정 및 UI 비노출
  - 2단계: 코드 경로 제거, 데이터 마이그레이션
  - 3단계: 컬럼 drop 및 스키마/스키마 모델 정리

5) [기능] 서버 검색 기능
- API: `host`, `group_id`, `is_active` 기반 검색/정렬/페이징
- UI: 검색바 + 결과 하이라이트

6) [UI/UX] 삭제 확인 팝업 개선
- 영향 범위 표시(세션/자원 연쇄 삭제 경고), 영구 삭제/보관 옵션

#### C. 자원사용률
1) [UI/UX] 테이블 헤더 고정, 임계치별 색상
- CSS sticky header, 임계치 레벨(경고/주의/정상) 컬러 매핑, 범례 제공

2) [UI/UX] 대상 선택 로직 개선
- 그룹/프록시 복수 선택, 최근/즐겨찾기, 빈 선택 방지

3) [기능] 그래프 구현 (1차 완료: 실시간/자동)
- API: 시계열 집계 없이 `collect + latest`로 실시간 갱신
- UI: Chart.js 라인 그래프(다중 프록시/지표), 수집 주기에 맞춰 자동 갱신(최근 1시간)
- 다음 단계: 임계치 라인/색상, 헤더 고정, 범례/툴팁 고도화
- AC: 1분 주기 리프레시 시 UI 60fps 유지, 서버 응답 1초 내

#### D. 신규 기능: 로그 수집(별도 프로젝트 권장)
- 목적: 트러블슈팅을 위한 로그 수집/검색
- 요구사항:
  - SSH 기반 장비별 일정 시간 로그 수집
  - 프록시별 로그 경로 설정
  - 수집 데이터 가공/색인/검색(UI)
- 제안 아키텍처:
  - 수집기(에이전트 또는 중앙 수집 파이프라인) + 저장소(예: S3/MinIO) + 색인(예: OpenSearch) + 뷰어(UI)
  - 수집 스케줄러(celery/apscheduler) + 비동기 업로드/색인
- AC: 대상 N대, 파일 합계 MGB 기준 시간 내 완료(세부 벤치마크 정의)

---

### 3. 현재 반영된 개선(코드 레벨)
- 프록시 응답 스키마 분리(`ProxyOut`)로 비밀번호 비노출, `ProxyUpdate` 부분 업데이트 허용
- 목록 API 페이지네이션 도입(`/api/proxies`, `/api/proxy-groups`, `/api/session-browser`, `/api/resource-usage`)
- 세션 브라우저: DataTables 서버사이드 엔드포인트(`/api/session-browser/datatables`) 추가, 필터/검색/정렬/페이징
- 세션 브라우저: 전체 컬럼 CSV 내보내기(`/api/session-browser/export`) 추가, 필터/검색/정렬 반영
- 세션 브라우저 SSH 호스트키 정책 준수(`auto_add`/`reject`)
- CORS/보안 헤더/헬스체크 추가, 문서 노출 환경변수화, `.env` 로딩
- 자원 사용률: Chart.js 실시간 그래프(UI), 집계 API 제거
- DB 연결 개선: `DATABASE_URL` 지원, `pool_pre_ping`
- Pydantic 기본값 안전화: 가변 기본값에 `default_factory`

---

### 4. 마이그레이션/변경 제안(요약)
- `proxies(host)` 유니크 인덱스 추가, 포트 제거 단계적 이행
- `session_records(proxy_id, collected_at)` 복합 인덱스 추가
- 집계/검색용 인덱스(필요 컬럼) 점진적 도입

---

### 5. 단계별 일정(예시)
- Phase 1 (1~2주): 중복 방지/검증, 세션 수집 성능/안정화, 그래프 기초
- Phase 2 (1~2주): 상세 검색/서식, 일괄 작업, 임계치 컬러/헤더 고정
- Phase 3 (1주): 엑셀 내보내기, 삭제 UX, 포트 제거 1/2단계
- Phase 4 (별도): 로그 수집 서브프로젝트 착수

